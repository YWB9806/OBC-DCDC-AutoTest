# 部署指南

## 目录
1. [系统要求](#系统要求)
2. [安装步骤](#安装步骤)
3. [配置说明](#配置说明)
4. [数据库初始化](#数据库初始化)
5. [启动应用](#启动应用)
6. [常见问题](#常见问题)
7. [升级指南](#升级指南)

---

## 系统要求

### 硬件要求
- **CPU**: 双核及以上
- **内存**: 4GB RAM 最低，8GB 推荐
- **磁盘**: 500MB 可用空间（不含测试脚本和数据）

### 软件要求
- **操作系统**: 
  - Windows 10/11
  - Linux (Ubuntu 20.04+, CentOS 7+)
  - macOS 10.15+
- **Python**: 3.8 或更高版本
- **pip**: 最新版本

---

## 安装步骤

### 1. 克隆或下载项目

```bash
# 使用 Git 克隆
git clone https://github.com/your-org/python-script-executor.git
cd python-script-executor

# 或下载 ZIP 并解压
```

### 2. 创建虚拟环境（推荐）

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/macOS
python3 -m venv venv
source venv/bin/activate
```

### 3. 安装依赖包

```bash
pip install -r requirements.txt
```

### 4. 验证安装

```bash
python -c "import PyQt5; import psutil; print('Dependencies installed successfully')"
```

---

## 配置说明

### 1. 应用配置

创建或编辑 `config/app_config.json`:

```json
{
  "app": {
    "name": "Python脚本批量执行工具",
    "version": "1.0.0",
    "log_level": "INFO"
  },
  "database": {
    "path": "data/script_executor.db",
    "backup_enabled": true,
    "backup_interval_hours": 24
  },
  "execution": {
    "max_workers": 1,
    "timeout_seconds": 3600,
    "retry_count": 0
  },
  "performance": {
    "monitoring_enabled": true,
    "monitoring_interval_seconds": 5,
    "metrics_retention_days": 30
  },
  "plugins": {
    "directory": "plugins",
    "auto_load": true
  }
}
```

### 2. 日志配置

创建或编辑 `config/logging_config.json`:

```json
{
  "version": 1,
  "disable_existing_loggers": false,
  "formatters": {
    "standard": {
      "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
    }
  },
  "handlers": {
    "console": {
      "class": "logging.StreamHandler",
      "level": "INFO",
      "formatter": "standard",
      "stream": "ext://sys.stdout"
    },
    "file": {
      "class": "logging.handlers.RotatingFileHandler",
      "level": "DEBUG",
      "formatter": "standard",
      "filename": "logs/app.log",
      "maxBytes": 10485760,
      "backupCount": 5
    }
  },
  "root": {
    "level": "DEBUG",
    "handlers": ["console", "file"]
  }
}
```

### 3. 目录结构

确保以下目录存在：

```bash
mkdir -p data
mkdir -p data/backups
mkdir -p logs
mkdir -p plugins
mkdir -p TestScripts
```

---

## 数据库初始化

### 自动初始化

首次运行应用时，数据库会自动创建和初始化。

### 手动初始化

如需手动初始化数据库：

```python
from AppCode.data_access.sqlite_data_access import SQLiteDataAccess

# 创建数据访问对象
db = SQLiteDataAccess('data/script_executor.db')

# 数据库会自动创建表结构
```

### 创建默认管理员账户

默认管理员账户会在首次启动时自动创建。

**重要**: 请联系系统管理员获取初始登录凭据，并在首次登录后立即修改密码！

---

## 启动应用

### 方式1: 使用启动脚本

```bash
# Windows
python run.py

# Linux/macOS
python3 run.py
```

### 方式2: 直接运行主程序

```bash
# Windows
python AppCode/main.py

# Linux/macOS
python3 AppCode/main.py
```

### 方式3: 创建快捷方式

#### Windows

创建 `启动.bat`:

```batch
@echo off
cd /d %~dp0
call venv\Scripts\activate
python run.py
pause
```

#### Linux/macOS

创建 `start.sh`:

```bash
#!/bin/bash
cd "$(dirname "$0")"
source venv/bin/activate
python3 run.py
```

赋予执行权限：

```bash
chmod +x start.sh
```

---

## 常见问题

### Q1: 导入 PyQt5 失败

**问题**: `ModuleNotFoundError: No module named 'PyQt5'`

**解决方案**:
```bash
pip install --upgrade PyQt5
```

### Q2: 数据库锁定错误

**问题**: `database is locked`

**解决方案**:
1. 确保没有其他实例在运行
2. 检查数据库文件权限
3. 重启应用

### Q3: 性能监控无法启动

**问题**: `ModuleNotFoundError: No module named 'psutil'`

**解决方案**:
```bash
pip install psutil
```

### Q4: 插件加载失败

**问题**: 插件无法加载

**解决方案**:
1. 检查插件文件语法
2. 确保插件实现了所有必需方法
3. 查看日志文件获取详细错误信息

### Q5: 权限不足

**问题**: 无法访问某些功能

**解决方案**:
1. 使用管理员账户登录
2. 检查用户角色和权限设置

---

## 升级指南

### 从旧版本升级

#### 1. 备份数据

```bash
# 备份数据库
cp data/script_executor.db data/script_executor.db.backup

# 备份配置
cp -r config config.backup
```

#### 2. 更新代码

```bash
git pull origin main
# 或下载新版本并解压
```

#### 3. 更新依赖

```bash
pip install --upgrade -r requirements.txt
```

#### 4. 数据库迁移

如果有数据库结构变更，运行迁移脚本：

```bash
python scripts/migrate_database.py
```

#### 5. 验证升级

```bash
python run.py --version
```

### 版本兼容性

| 版本 | Python | PyQt5 | 数据库 |
|------|--------|-------|--------|
| 1.0.0 | 3.8+ | 5.15+ | SQLite 3 |

---

## 生产环境部署

### 1. 使用系统服务（Linux）

创建 systemd 服务文件 `/etc/systemd/system/script-executor.service`:

```ini
[Unit]
Description=Python Script Executor
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/python-script-executor
Environment="PATH=/path/to/python-script-executor/venv/bin"
ExecStart=/path/to/python-script-executor/venv/bin/python run.py
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl enable script-executor
sudo systemctl start script-executor
sudo systemctl status script-executor
```

### 2. 使用 Docker（可选）

创建 `Dockerfile`:

```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# 创建必要目录
RUN mkdir -p data logs plugins

# 暴露端口（如果需要）
# EXPOSE 8000

# 启动应用
CMD ["python", "run.py"]
```

构建和运行：

```bash
docker build -t script-executor .
docker run -d --name script-executor \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/logs:/app/logs \
  script-executor
```

### 3. 反向代理（Nginx）

如果需要 Web 访问，配置 Nginx:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 性能优化

### 1. 数据库优化

```sql
-- 定期清理旧数据
DELETE FROM execution_history WHERE created_at < datetime('now', '-90 days');

-- 重建索引
REINDEX;

-- 清理数据库
VACUUM;
```

### 2. 日志管理

定期清理旧日志：

```bash
# Linux/macOS
find logs/ -name "*.log" -mtime +30 -delete

# Windows PowerShell
Get-ChildItem logs\*.log | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item
```

### 3. 备份策略

设置自动备份任务：

```bash
# Linux cron
0 2 * * * /path/to/backup_script.sh

# Windows 任务计划程序
schtasks /create /tn "ScriptExecutorBackup" /tr "C:\path\to\backup_script.bat" /sc daily /st 02:00
```

---

## 监控和维护

### 1. 健康检查

定期检查应用状态：

```bash
# 检查进程
ps aux | grep python | grep run.py

# 检查日志
tail -f logs/app.log

# 检查数据库大小
du -h data/script_executor.db
```

### 2. 性能监控

使用内置性能监控功能：
1. 打开应用
2. 进入"性能监控"标签页
3. 查看实时指标和历史数据

### 3. 备份验证

定期验证备份完整性：

```bash
# 测试恢复备份
python -c "from AppCode.services.backup_service import BackupService; \
           bs = BackupService('data', 'data/backups'); \
           print('Backup test:', bs.list_backups())"
```

---

## 安全建议

1. **修改初始密码**: 首次登录后立即修改密码
2. **限制访问**: 仅授权用户可访问应用
3. **定期备份**: 启用自动备份功能
4. **更新依赖**: 定期更新 Python 包
5. **日志审计**: 定期检查日志文件
6. **权限控制**: 合理分配用户角色和权限
7. **密码安全**: 使用强密码并定期更换

---

## 技术支持

如遇到问题，请：
1. 查看日志文件 `logs/app.log`
2. 参考[常见问题](#常见问题)章节
3. 查阅[用户手册](./用户手册.md)
4. 联系技术支持团队

---

## 附录

### A. 环境变量

可选的环境变量配置：

```bash
# 数据库路径
export SCRIPT_EXECUTOR_DB_PATH=/custom/path/database.db

# 日志级别
export SCRIPT_EXECUTOR_LOG_LEVEL=DEBUG

# 插件目录
export SCRIPT_EXECUTOR_PLUGIN_DIR=/custom/plugins
```

### B. 命令行参数

```bash
python run.py --help
python run.py --version
python run.py --config /path/to/config.json
python run.py --debug
```

### C. 系统要求检查脚本

创建 `check_requirements.py`:

```python
import sys
import platform

print("系统信息:")
print(f"  操作系统: {platform.system()} {platform.release()}")
print(f"  Python版本: {sys.version}")
print(f"  架构: {platform.machine()}")

print("\n检查依赖包:")
try:
    import PyQt5
    print("  ✓ PyQt5")
except ImportError:
    print("  ✗ PyQt5 (未安装)")

try:
    import psutil
    print("  ✓ psutil")
except ImportError:
    print("  ✗ psutil (未安装)")

print("\n检查完成!")
```

运行检查：

```bash
python check_requirements.py
```

---

**最后更新**: 2024-12-12
**文档版本**: 1.0.0