name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller build.spec

      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path OBC-DCDC-AutoTest -DestinationPath OBC-DCDC-AutoTest-Windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/OBC-DCDC-AutoTest-Windows.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller build.spec

      - name: Create TAR archive
        run: |
          cd dist
          tar -czf OBC-DCDC-AutoTest-Linux.tar.gz OBC-DCDC-AutoTest

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/OBC-DCDC-AutoTest-Linux.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller build.spec

      - name: Create DMG (optional)
        run: |
          cd dist
          # å¦‚æžœéœ€è¦åˆ›å»ºDMGï¼Œå¯ä»¥ä½¿ç”¨create-dmgå·¥å…·
          # brew install create-dmg
          # create-dmg --volname "OBC-DCDC AutoTest" --window-pos 200 120 --window-size 800 400 OBC-DCDC-AutoTest.dmg OBC-DCDC-AutoTest.app
          tar -czf OBC-DCDC-AutoTest-macOS.tar.gz OBC-DCDC-AutoTest.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/OBC-DCDC-AutoTest-macOS.tar.gz

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ### ðŸ“¦ ä¸‹è½½
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
          
          - **Windows**: `OBC-DCDC-AutoTest-Windows.zip`
          - **Linux**: `OBC-DCDC-AutoTest-Linux.tar.gz`
          - **macOS**: `OBC-DCDC-AutoTest-macOS.tar.gz`

          ### âœ¨ æ›´æ–°å†…å®¹

          è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

          ### ðŸ“ å®‰è£…è¯´æ˜Ž

          #### Windows
          1. ä¸‹è½½ `OBC-DCDC-AutoTest-Windows.zip`
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `OBC-DCDC-AutoTest.exe`

          #### Linux
          1. ä¸‹è½½ `OBC-DCDC-AutoTest-Linux.tar.gz`
          2. è§£åŽ‹: `tar -xzf OBC-DCDC-AutoTest-Linux.tar.gz`
          3. è¿è¡Œ: `./OBC-DCDC-AutoTest/OBC-DCDC-AutoTest`

          #### macOS
          1. ä¸‹è½½ `OBC-DCDC-AutoTest-macOS.tar.gz`
          2. è§£åŽ‹: `tar -xzf OBC-DCDC-AutoTest-macOS.tar.gz`
          3. å°† `OBC-DCDC-AutoTest.app` æ‹–åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸

          ### ðŸ› é—®é¢˜åé¦ˆ

          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/YWB9806/OBC-DCDC-AutoTest/issues) ä¸­åé¦ˆã€‚

          ### ðŸ“š æ–‡æ¡£

          - [ç”¨æˆ·æ‰‹å†Œ](documents/è½¯ä»¶å¼€å‘æ‰‹å†Œ.md)
          - [éƒ¨ç½²æŒ‡å—](documents/éƒ¨ç½²æŒ‡å—.md)
          - [APIæ–‡æ¡£](documents/APIæŽ¥å£æ–‡æ¡£.md)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'alpha') }}
          files: |
            artifacts/windows-build/OBC-DCDC-AutoTest-Windows.zip
            artifacts/linux-build/OBC-DCDC-AutoTest-Linux.tar.gz
            artifacts/macos-build/OBC-DCDC-AutoTest-macOS.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.get_version.outputs.version }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Release creation failed!"
          exit 1