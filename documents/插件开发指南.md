# 插件开发指南

## 目录
1. [概述](#概述)
2. [插件接口](#插件接口)
3. [开发步骤](#开发步骤)
4. [示例插件](#示例插件)
5. [最佳实践](#最佳实践)
6. [调试技巧](#调试技巧)

---

## 概述

Python脚本批量执行工具提供了灵活的插件系统，允许开发者扩展系统功能。插件系统支持多种类型的插件：

- **通用插件 (IPlugin)**: 基础插件接口
- **报告插件 (IReportPlugin)**: 生成各种格式的报告
- **分析器插件 (IAnalyzerPlugin)**: 数据分析和洞察
- **通知插件 (INotificationPlugin)**: 发送通知消息

---

## 插件接口

### 1. 基础插件接口 (IPlugin)

所有插件都必须实现 `IPlugin` 接口：

```python
from AppCode.interfaces.i_plugin import IPlugin
from typing import Dict, Any

class MyPlugin(IPlugin):
    def get_name(self) -> str:
        """返回插件名称"""
        return "MyPlugin"
    
    def get_version(self) -> str:
        """返回插件版本"""
        return "1.0.0"
    
    def get_description(self) -> str:
        """返回插件描述"""
        return "我的自定义插件"
    
    def get_author(self) -> str:
        """返回插件作者"""
        return "Your Name"
    
    def initialize(self, context: Dict[str, Any]) -> bool:
        """初始化插件
        
        Args:
            context: 应用上下文，包含服务和配置
            
        Returns:
            初始化是否成功
        """
        self._context = context
        return True
    
    def execute(self, *args, **kwargs) -> Any:
        """执行插件主要功能
        
        Args:
            *args: 位置参数
            **kwargs: 关键字参数
            
        Returns:
            执行结果
        """
        # 实现插件逻辑
        return "执行结果"
    
    def cleanup(self):
        """清理插件资源"""
        pass
    
    def get_config_schema(self) -> Dict[str, Any]:
        """返回配置模式"""
        return {
            'param1': 'string - 参数1说明',
            'param2': 'int - 参数2说明'
        }
    
    def update_config(self, config: Dict[str, Any]):
        """更新插件配置"""
        self._config.update(config)
```

### 2. 报告插件接口 (IReportPlugin)

用于生成各种格式的报告：

```python
from AppCode.interfaces.i_plugin import IReportPlugin

class MyReportPlugin(IReportPlugin):
    # 实现 IPlugin 的所有方法...
    
    def generate_report(self, data: Dict[str, Any]) -> str:
        """生成报告
        
        Args:
            data: 报告数据
            
        Returns:
            报告内容（字符串）
        """
        return "报告内容"
    
    def get_supported_formats(self) -> list:
        """返回支持的报告格式"""
        return ['html', 'pdf', 'markdown']
    
    def save_report(self, report: str, file_path: str) -> bool:
        """保存报告到文件
        
        Args:
            report: 报告内容
            file_path: 文件路径
            
        Returns:
            是否保存成功
        """
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(report)
            return True
        except:
            return False
```

### 3. 分析器插件接口 (IAnalyzerPlugin)

用于数据分析：

```python
from AppCode.interfaces.i_plugin import IAnalyzerPlugin

class MyAnalyzerPlugin(IAnalyzerPlugin):
    # 实现 IPlugin 的所有方法...
    
    def analyze_data(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
        """分析数据
        
        Args:
            data: 要分析的数据
            
        Returns:
            分析结果
        """
        return {
            'statistics': {},
            'trends': {},
            'insights': []
        }
    
    def get_supported_data_types(self) -> List[str]:
        """返回支持的数据类型"""
        return ['execution_results', 'performance_metrics']
    
    def generate_insights(self, analysis_result: Dict[str, Any]) -> List[str]:
        """生成洞察建议
        
        Args:
            analysis_result: 分析结果
            
        Returns:
            洞察建议列表
        """
        return ["建议1", "建议2"]
```

### 4. 通知插件接口 (INotificationPlugin)

用于发送通知：

```python
from AppCode.interfaces.i_plugin import INotificationPlugin

class MyNotificationPlugin(INotificationPlugin):
    # 实现 IPlugin 的所有方法...
    
    def send_notification(
        self,
        message: str,
        level: str = 'info',
        data: Dict[str, Any] = None
    ) -> Dict[str, Any]:
        """发送通知
        
        Args:
            message: 通知消息
            level: 通知级别 (info/warning/error)
            data: 附加数据
            
        Returns:
            发送结果
        """
        return {
            'success': True,
            'message': '通知已发送'
        }
    
    def get_supported_channels(self) -> List[str]:
        """返回支持的通知渠道"""
        return ['email', 'sms', 'webhook']
    
    def test_connection(self, channel: str) -> bool:
        """测试通知渠道连接
        
        Args:
            channel: 通知渠道
            
        Returns:
            是否连接成功
        """
        return True
```

---

## 开发步骤

### 步骤1: 创建插件文件

在 `plugins/` 目录下创建新的 Python 文件：

```bash
plugins/
  └── my_custom_plugin.py
```

### 步骤2: 导入必要的模块

```python
from typing import Dict, Any, List
from AppCode.interfaces.i_plugin import IPlugin  # 或其他接口
```

### 步骤3: 实现插件类

```python
class MyCustomPlugin(IPlugin):
    def __init__(self):
        self._context = None
        self._config = {
            # 默认配置
        }
    
    # 实现所有必需的方法...
```

### 步骤4: 测试插件

```python
if __name__ == '__main__':
    # 测试代码
    plugin = MyCustomPlugin()
    plugin.initialize({})
    result = plugin.execute()
    print(result)
```

### 步骤5: 加载插件

通过插件管理界面加载插件，或使用代码：

```python
plugin_manager.load_plugin('plugins/my_custom_plugin.py')
```

---

## 示例插件

### 示例1: 简单的报告插件

```python
from AppCode.interfaces.i_plugin import IReportPlugin
from datetime import datetime

class SimpleReportPlugin(IReportPlugin):
    def __init__(self):
        self._context = None
    
    def get_name(self) -> str:
        return "SimpleReportPlugin"
    
    def get_version(self) -> str:
        return "1.0.0"
    
    def get_description(self) -> str:
        return "生成简单的文本报告"
    
    def get_author(self) -> str:
        return "Developer"
    
    def initialize(self, context: Dict[str, Any]) -> bool:
        self._context = context
        return True
    
    def execute(self, *args, **kwargs) -> Any:
        data = kwargs.get('data', {})
        return self.generate_report(data)
    
    def cleanup(self):
        pass
    
    def get_config_schema(self) -> Dict[str, Any]:
        return {}
    
    def update_config(self, config: Dict[str, Any]):
        pass
    
    def generate_report(self, data: Dict[str, Any]) -> str:
        report = f"""
测试执行报告
生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

总执行数: {data.get('total', 0)}
成功数: {data.get('success', 0)}
失败数: {data.get('failed', 0)}
成功率: {data.get('success_rate', 0):.2f}%
"""
        return report
    
    def get_supported_formats(self) -> list:
        return ['text']
    
    def save_report(self, report: str, file_path: str) -> bool:
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(report)
            return True
        except:
            return False
```

### 示例2: 数据分析插件

参见 `plugins/example_analyzer_plugin.py`

### 示例3: 通知插件

参见 `plugins/example_notification_plugin.py`

---

## 最佳实践

### 1. 错误处理

始终使用 try-except 处理可能的错误：

```python
def execute(self, *args, **kwargs) -> Any:
    try:
        # 插件逻辑
        return result
    except Exception as e:
        print(f"[{self.get_name()}] Error: {e}")
        return {'error': str(e)}
```

### 2. 日志记录

使用日志记录重要操作：

```python
def initialize(self, context: Dict[str, Any]) -> bool:
    try:
        self._context = context
        print(f"[{self.get_name()}] Initialized successfully")
        return True
    except Exception as e:
        print(f"[{self.get_name()}] Initialization failed: {e}")
        return False
```

### 3. 配置验证

验证配置参数：

```python
def update_config(self, config: Dict[str, Any]):
    # 验证必需参数
    required_params = ['param1', 'param2']
    for param in required_params:
        if param not in config:
            raise ValueError(f"Missing required parameter: {param}")
    
    self._config.update(config)
```

### 4. 资源清理

在 cleanup() 方法中释放资源：

```python
def cleanup(self):
    # 关闭文件
    if hasattr(self, '_file') and self._file:
        self._file.close()
    
    # 断开连接
    if hasattr(self, '_connection') and self._connection:
        self._connection.close()
```

### 5. 文档字符串

为所有方法添加详细的文档字符串：

```python
def analyze_data(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
    """分析执行数据
    
    Args:
        data: 执行数据列表，每个元素包含:
            - name: 脚本名称
            - status: 执行状态
            - duration: 执行时长
            - timestamp: 执行时间
    
    Returns:
        分析结果字典，包含:
            - statistics: 统计信息
            - trends: 趋势分析
            - anomalies: 异常检测结果
    
    Raises:
        ValueError: 数据格式不正确时
    """
    pass
```

---

## 调试技巧

### 1. 使用打印调试

```python
def execute(self, *args, **kwargs) -> Any:
    print(f"[DEBUG] Args: {args}")
    print(f"[DEBUG] Kwargs: {kwargs}")
    
    result = self._process_data(kwargs.get('data'))
    
    print(f"[DEBUG] Result: {result}")
    return result
```

### 2. 单独测试插件

在插件文件末尾添加测试代码：

```python
if __name__ == '__main__':
    # 创建插件实例
    plugin = MyPlugin()
    
    # 初始化
    context = {'app': 'test'}
    assert plugin.initialize(context), "Initialization failed"
    
    # 测试执行
    result = plugin.execute(data={'test': 'data'})
    print(f"Result: {result}")
    
    # 清理
    plugin.cleanup()
```

### 3. 使用日志文件

```python
import logging

class MyPlugin(IPlugin):
    def __init__(self):
        self.logger = logging.getLogger(self.get_name())
        handler = logging.FileHandler(f'{self.get_name()}.log')
        self.logger.addHandler(handler)
        self.logger.setLevel(logging.DEBUG)
    
    def execute(self, *args, **kwargs) -> Any:
        self.logger.debug(f"Execute called with: {kwargs}")
        # ...
```

### 4. 异常追踪

```python
import traceback

def execute(self, *args, **kwargs) -> Any:
    try:
        # 插件逻辑
        pass
    except Exception as e:
        print(f"[ERROR] {e}")
        print(traceback.format_exc())
        return {'error': str(e)}
```

---

## 常见问题

### Q: 插件加载失败？

**A:** 检查以下几点：
1. 插件文件是否在 `plugins/` 目录下
2. 插件类是否正确继承了接口
3. 是否实现了所有必需的方法
4. Python 语法是否正确

### Q: 如何访问应用服务？

**A:** 通过 context 参数：

```python
def initialize(self, context: Dict[str, Any]) -> bool:
    self._context = context
    
    # 访问服务
    if 'logger' in context:
        self.logger = context['logger']
    
    if 'database' in context:
        self.db = context['database']
    
    return True
```

### Q: 如何持久化插件数据？

**A:** 使用文件或数据库：

```python
import json

def save_state(self):
    state = {
        'config': self._config,
        'data': self._data
    }
    with open(f'{self.get_name()}_state.json', 'w') as f:
        json.dump(state, f)

def load_state(self):
    try:
        with open(f'{self.get_name()}_state.json', 'r') as f:
            state = json.load(f)
            self._config = state['config']
            self._data = state['data']
    except FileNotFoundError:
        pass
```

---

## 参考资源

- [插件接口定义](../AppCode/interfaces/i_plugin.py)
- [示例报告插件](../plugins/example_report_plugin.py)
- [示例分析器插件](../plugins/example_analyzer_plugin.py)
- [示例通知插件](../plugins/example_notification_plugin.py)
- [插件管理器源码](../AppCode/core/plugin_manager.py)

---

## 联系支持

如有问题或建议，请联系开发团队。