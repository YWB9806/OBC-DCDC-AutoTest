# 打包测试指南

## 📋 环境信息

- **Python版本**: 3.10.19 ✅
- **Conda环境**: script_executor
- **操作系统**: Windows
- **GUI框架**: PyQt5

---

## 🚀 第二步：本地打包测试

### 1. 安装依赖

在 `script_executor` 环境中执行：

```bash
# 确认当前环境
conda activate script_executor
python --version  # 应显示 Python 3.10.19

# 安装项目依赖
pip install -r requirements.txt

# 安装PyInstaller
pip install pyinstaller
```

### 2. 检查依赖是否安装成功

```bash
# 检查关键依赖
python -c "import PyQt5; print('PyQt5:', PyQt5.QtCore.QT_VERSION_STR)"
python -c "import sqlalchemy; print('SQLAlchemy:', sqlalchemy.__version__)"
python -c "import bcrypt; print('bcrypt:', bcrypt.__version__)"
python -c "import PyInstaller; print('PyInstaller:', PyInstaller.__version__)"
```

### 3. 测试应用是否能正常运行

```bash
# 运行主程序
python run.py
```

**预期结果**：
- 应用正常启动
- 显示登录界面
- 可以正常登录

### 4. 执行打包

```bash
# 清理旧的构建文件（如果有）
rmdir /s /q build dist

# 执行打包
pyinstaller build.spec
```

**打包过程说明**：
- 分析依赖关系
- 收集所有必要文件
- 创建可执行文件
- 打包到 `dist/OBC-DCDC-AutoTest` 目录

**预期输出**：
```
Building EXE from EXE-00.toc completed successfully.
```

### 5. 测试打包结果

```bash
# 进入打包目录
cd dist\OBC-DCDC-AutoTest

# 运行可执行文件
OBC-DCDC-AutoTest.exe
```

**测试清单**：
- [ ] 应用能正常启动
- [ ] 登录功能正常
- [ ] 脚本浏览功能正常
- [ ] 脚本执行功能正常
- [ ] 更新检查功能正常（如果已集成）
- [ ] 数据库连接正常
- [ ] 日志记录正常

---

## 🐛 常见问题排查

### 问题1: 缺少模块

**错误信息**：
```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**：
1. 在 `build.spec` 的 `hiddenimports` 中添加缺失的模块：
```python
hiddenimports = [
    'PyQt5.QtCore',
    'PyQt5.QtGui',
    'PyQt5.QtWidgets',
    'xxx',  # 添加缺失的模块
]
```

2. 重新打包：
```bash
pyinstaller build.spec
```

### 问题2: 找不到配置文件

**错误信息**：
```
FileNotFoundError: config/app_config.json
```

**解决方案**：
确保 `build.spec` 中包含了配置文件：
```python
datas = [
    ('AppCode/config/app_config.json', 'AppCode/config'),
    ('config/app_config.json', 'config'),
]
```

### 问题3: 数据库文件路径问题

**解决方案**：
确保数据库文件路径使用相对路径或正确处理打包后的路径。

### 问题4: PyQt5相关错误

**错误信息**：
```
ImportError: DLL load failed
```

**解决方案**：
```bash
# 重新安装PyQt5
pip uninstall PyQt5 PyQt5-Qt5 PyQt5-sip
pip install PyQt5
```

---

## 📦 打包结果说明

### 目录结构

```
dist/
└── OBC-DCDC-AutoTest/
    ├── OBC-DCDC-AutoTest.exe    # 主程序
    ├── _internal/                # 依赖文件
    │   ├── PyQt5/
    │   ├── sqlalchemy/
    │   └── ...
    ├── config/                   # 配置文件
    │   └── app_config.json
    └── data/                     # 数据文件（如果有）
```

### 文件大小

预期大小：约 100-200 MB（包含所有依赖）

---

## ✅ 打包成功标志

如果看到以下情况，说明打包成功：

1. ✅ `dist/OBC-DCDC-AutoTest` 目录存在
2. ✅ `OBC-DCDC-AutoTest.exe` 文件存在
3. ✅ 双击exe文件能正常启动应用
4. ✅ 所有功能正常工作
5. ✅ 没有报错信息

---

## 📝 打包后的测试步骤

### 1. 基本功能测试

```bash
cd dist\OBC-DCDC-AutoTest
OBC-DCDC-AutoTest.exe
```

- [ ] 应用启动
- [ ] 登录功能
- [ ] 主界面显示
- [ ] 菜单功能

### 2. 核心功能测试

- [ ] 脚本浏览
- [ ] 脚本执行
- [ ] 结果查看
- [ ] 历史记录
- [ ] 用户管理

### 3. 更新功能测试（如果已集成）

- [ ] 手动检查更新
- [ ] 更新对话框显示
- [ ] 版本信息正确

---

## 🎯 下一步

打包测试成功后，可以进行：

1. **创建压缩包**
   ```bash
   # 在dist目录下
   powershell -Command "Compress-Archive -Path OBC-DCDC-AutoTest -DestinationPath OBC-DCDC-AutoTest-Windows.zip"
   ```

2. **准备发布**
   - 测试压缩包
   - 准备发布说明
   - 更新CHANGELOG.md

3. **执行发布**
   ```bash
   # 返回项目根目录
   cd ..\..
   
   # 运行发布脚本
   release.bat 1.0.0
   ```

---

## 📞 需要帮助？

如果遇到问题：

1. 查看错误日志
2. 检查 [常见问题](#常见问题排查)
3. 查看 [兼容性说明](./兼容性说明.md)
4. 提交 [Issue](https://github.com/YWB9806/OBC-DCDC-AutoTest/issues)

---

**创建时间**: 2025-12-13  
**适用环境**: Windows + Python 3.10 + PyQt5