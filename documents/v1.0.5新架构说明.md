# v1.0.5 新架构说明

## 🎯 核心改进

### 问题分析
v1.0.4 版本存在以下问题：
1. **自动加载TestScripts目录** - 用户无法控制加载哪些脚本
2. **无法直观查看待执行脚本** - 选择后不知道选了什么
3. **自定义脚本无法精细控制** - 添加文件夹后无法选择性添加脚本
4. **缺少执行队列概念** - 选择和执行混在一起

### 解决方案
重新设计脚本选择和执行流程，引入**三栏布局**和**执行队列**概念。

---

## 📐 新架构设计

### 三栏布局

```
┌─────────────────────────────────────────────────────────────────┐
│                        主窗口                                    │
├──────────────┬──────────────┬──────────────────────────────────┤
│              │              │                                   │
│  脚本浏览器   │  执行队列     │        标签页                     │
│ (临时脚本池)  │ (待执行列表)  │  - 执行控制                       │
│              │              │  - 执行结果                       │
│              │              │  - 用户管理                       │
│              │              │                                   │
│              │              │                                   │
└──────────────┴──────────────┴──────────────────────────────────┘
   占2份          占1份            占3份
```

### 工作流程

```
1. 用户点击"添加路径"
   ↓
2. 选择文件夹/文件
   ↓
3. 弹出【脚本选择对话框】
   - 显示所有找到的脚本
   - 用户勾选需要的脚本
   - 支持搜索、全选、反选
   ↓
4. 选中的脚本添加到【脚本浏览器】（左侧）
   - 作为临时脚本池
   - 可以浏览、搜索
   ↓
5. 用户在脚本浏览器中勾选脚本
   ↓
6. 点击"添加到执行列表 →"按钮
   ↓
7. 脚本添加到【执行队列】（中间）
   - 显示序号和脚本名称
   - 可以调整顺序（上移/下移）
   - 可以删除单个脚本
   - 可以清空队列
   ↓
8. 点击执行队列中的"开始执行"按钮
   ↓
9. 批量执行队列中的所有脚本
```

---

## 🆕 新增组件

### 1. 脚本选择对话框 (`script_selection_dialog.py`)

**功能**：
- 显示文件夹中所有找到的Python脚本
- 树形结构显示（按文件夹分组）
- 复选框选择脚本
- 搜索过滤功能
- 全选/全不选/反选
- 显示文件大小和相对路径

**使用场景**：
- 用户添加文件夹时自动弹出
- 让用户精确控制要添加哪些脚本

**代码位置**：`AppCode/ui/script_selection_dialog.py`

### 2. 执行队列面板 (`execution_queue_panel.py`)

**功能**：
- 显示待执行的脚本列表（带序号）
- 上移/下移调整执行顺序
- 移除单个脚本
- 清空整个队列
- 双击查看脚本详情
- 右键菜单快捷操作
- 大号"开始执行"按钮

**特点**：
- 直观显示待执行内容
- 灵活调整执行顺序
- 避免重复添加

**代码位置**：`AppCode/ui/execution_queue_panel.py`

---

## 🔄 修改的组件

### 1. 脚本浏览器 (`script_browser.py`)

**主要变更**：

#### 移除自动加载
```python
# 旧版本：自动加载TestScripts目录
root_path = self.config_manager.get('scripts.root_path', 'TestScripts')
if os.path.exists(root_path):
    result = self.script_service.scan_and_load_scripts(root_path)

# 新版本：不自动加载，由用户手动添加
self._root_path = None
all_scripts = []
```

#### 新增功能
1. **脚本选择对话框集成**
   ```python
   def _add_custom_folder_with_selection(self, folder_path):
       # 扫描脚本
       all_scripts = self.script_service.scan_and_load_scripts(folder_path)
       
       # 弹出选择对话框
       dialog = ScriptSelectionDialog(all_scripts, folder_path, self)
       if dialog.exec_() == dialog.Accepted:
           selected_scripts = dialog.get_selected_scripts()
           # 只添加用户选择的脚本
   ```

2. **添加到执行列表按钮**
   ```python
   self.add_to_queue_btn = QPushButton("添加到执行列表 →")
   self.add_to_queue_btn.clicked.connect(self._on_add_to_queue)
   ```

3. **新增信号**
   ```python
   add_to_queue_requested = pyqtSignal(list, list)  # (paths, info_list)
   ```

### 2. 主窗口 (`main_window.py`)

**主要变更**：

#### 布局改为三栏
```python
# 旧版本：两栏布局
splitter.addWidget(self.script_browser)  # 左侧
splitter.addWidget(self.tab_widget)      # 右侧

# 新版本：三栏布局
splitter.addWidget(self.script_browser)      # 左侧
splitter.addWidget(self.execution_queue)     # 中间
splitter.addWidget(self.tab_widget)          # 右侧
```

#### 新增信号连接
```python
# 脚本浏览器 -> 执行队列
self.script_browser.add_to_queue_requested.connect(self._on_add_to_queue)

# 执行队列 -> 执行面板
self.execution_queue.execute_requested.connect(self._on_execute_queue)
```

#### 修改执行逻辑
```python
# 旧版本：从脚本浏览器直接执行
def _on_start_execution(self):
    selected_scripts = self.script_browser.get_selected_scripts()
    self.execution_panel.start_execution(selected_scripts)

# 新版本：从执行队列执行
def _on_start_execution(self):
    queue = self.execution_queue.get_queue()
    if not queue:
        QMessageBox.warning(self, "警告", "执行队列为空")
        return
    self._on_execute_queue(queue)
```

---

## 💡 使用示例

### 场景1：添加TestScripts目录中的部分脚本

```
1. 点击"添加路径" -> "添加整个文件夹"
2. 选择 TestScripts/Demo 文件夹
3. 弹出对话框显示所有脚本
4. 搜索 "LED" 过滤脚本
5. 勾选需要的LED相关脚本
6. 点击"确定添加"
7. 脚本出现在左侧浏览器中
8. 勾选要执行的脚本
9. 点击"添加到执行列表 →"
10. 脚本出现在中间执行队列
11. 调整执行顺序（如果需要）
12. 点击"开始执行"
```

### 场景2：添加自定义位置的脚本

```
1. 点击"添加路径" -> "添加整个文件夹"
2. 选择 D:\MyScripts 文件夹
3. 在对话框中勾选需要的脚本
4. 添加到脚本浏览器
5. 继续添加其他位置的脚本
6. 从多个来源选择脚本
7. 统一添加到执行队列
8. 一次性批量执行
```

### 场景3：管理执行队列

```
1. 执行队列中有10个脚本
2. 发现某个脚本不需要执行
   -> 右键点击 -> "移除"
3. 需要调整执行顺序
   -> 选中脚本 -> 点击"上移"/"下移"
4. 想查看脚本详情
   -> 双击脚本项
5. 想清空重新选择
   -> 点击"清空"按钮
```

---

## 🎨 UI改进

### 视觉层次

1. **脚本浏览器**（左侧）
   - 标题：脚本浏览器
   - 功能：临时脚本池
   - 颜色：默认

2. **执行队列**（中间）
   - 标题：执行队列 (数量)
   - 功能：待执行列表
   - 执行按钮：绿色高亮

3. **标签页**（右侧）
   - 执行控制
   - 执行结果
   - 用户管理

### 按钮样式

```python
# 添加到执行列表按钮 - 蓝色
self.add_to_queue_btn.setStyleSheet("""
    QPushButton {
        background-color: #2196F3;
        color: white;
        font-weight: bold;
    }
""")

# 开始执行按钮 - 绿色
self.execute_btn.setStyleSheet("""
    QPushButton {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
        font-size: 11pt;
    }
""")
```

---

## 🔧 技术细节

### 信号流转

```
ScriptBrowser.add_to_queue_requested
    ↓
MainWindow._on_add_to_queue
    ↓
ExecutionQueuePanel.add_scripts
    ↓
ExecutionQueuePanel.queue_changed (信号)
    ↓
MainWindow._on_queue_changed

ExecutionQueuePanel.execute_requested
    ↓
MainWindow._on_execute_queue
    ↓
ExecutionPanel.start_execution
```

### 数据结构

```python
# 脚本浏览器
self._scripts = [
    {
        'name': 'test.py',
        'path': '/full/path/to/test.py',
        'category': 'Demo',
        ...
    },
    ...
]

# 执行队列
self._queue = [
    '/full/path/to/script1.py',
    '/full/path/to/script2.py',
    ...
]

self._script_info_map = {
    '/full/path/to/script1.py': {...},
    '/full/path/to/script2.py': {...},
}
```

---

## ✅ 优势

### 1. 用户体验
- ✅ 完全控制加载哪些脚本
- ✅ 直观看到待执行内容
- ✅ 灵活调整执行顺序
- ✅ 避免误操作

### 2. 功能性
- ✅ 支持多来源脚本
- ✅ 精细化脚本选择
- ✅ 队列管理功能
- ✅ 可重复使用队列

### 3. 可维护性
- ✅ 职责分离清晰
- ✅ 组件独立可测试
- ✅ 信号机制解耦
- ✅ 易于扩展

---

## 🚀 未来扩展

### 可能的增强功能

1. **队列持久化**
   - 保存执行队列到文件
   - 下次启动自动加载

2. **队列模板**
   - 保存常用队列为模板
   - 快速加载预设队列

3. **批量操作**
   - 批量移除脚本
   - 批量调整顺序

4. **执行策略**
   - 失败后继续/停止
   - 超时设置
   - 并行执行

5. **队列分组**
   - 按类别分组
   - 分组执行

---

## 📝 迁移指南

### 从 v1.0.4 升级到 v1.0.5

#### 用户操作变化

**旧版本**：
1. 启动应用 -> TestScripts自动加载
2. 勾选脚本
3. 点击执行

**新版本**：
1. 启动应用 -> 空白状态
2. 点击"添加路径"
3. 选择文件夹
4. 在对话框中勾选脚本
5. 脚本添加到浏览器
6. 勾选要执行的脚本
7. 点击"添加到执行列表"
8. 在执行队列中点击"开始执行"

#### 代码变化

**脚本浏览器**：
- 移除自动加载逻辑
- 新增脚本选择对话框
- 新增添加到队列功能

**主窗口**：
- 布局从两栏改为三栏
- 新增执行队列面板
- 修改执行逻辑

---

## 🐛 已知问题

### 1. 队列不持久化
- **问题**：应用重启后队列清空
- **影响**：需要重新添加脚本
- **计划**：v1.0.6 添加持久化

### 2. 脚本浏览器不持久化
- **问题**：应用重启后临时脚本池清空
- **影响**：需要重新添加路径
- **计划**：v1.0.6 添加持久化

---

## 📊 性能影响

### 启动速度
- **旧版本**：自动扫描TestScripts，启动较慢
- **新版本**：不自动加载，启动更快

### 内存占用
- **影响**：新增执行队列面板，略微增加
- **优化**：队列只存储路径，不存储完整信息

---

## 🎓 设计理念

### 1. 用户主导
- 用户完全控制加载什么
- 用户明确知道要执行什么
- 用户可以随时调整

### 2. 职责分离
- 脚本浏览器：管理可用脚本
- 执行队列：管理待执行脚本
- 执行面板：执行和监控

### 3. 渐进式操作
- 添加 -> 选择 -> 排队 -> 执行
- 每一步都可以调整
- 降低误操作风险

---

## 📞 反馈

如有问题或建议，请联系开发团队或提交Issue。

---

**文档版本**：v1.0.5  
**更新日期**：2025-12-14  
**作者**：开发团队