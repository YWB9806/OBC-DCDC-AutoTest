# 更新日志

所有重要的项目更改都将记录在此文件中。

本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范。

## [1.1.0] - 2025-12-23

### 修复
- 🐛 **用户权限保存问题**：修复了创建用户时"允许查看执行结果"权限未正确保存的bug
  - 问题：在用户管理界面创建用户时勾选"允许查看执行结果"，但保存后用户列表显示"否"
  - 根本原因：[`UserService.create_user()`](AppCode/services/user_service.py:177)方法缺少`can_view_results`参数
  - 修复位置：
    - [`AppCode/services/user_service.py`](AppCode/services/user_service.py:177) - 添加`can_view_results`参数
    - [`AppCode/ui/user_panel.py`](AppCode/ui/user_panel.py:256) - 传递`can_view_results`值到服务层
  - 修复内容：
    - 在`create_user()`方法中添加`can_view_results`参数（默认值为0）
    - 超级管理员自动拥有查看结果权限（强制设置为1）
    - 在用户面板创建用户时正确传递该参数值
  - 影响：现在创建用户时勾选的权限能正确保存到数据库并在列表中显示

### 新增
- ✨ **默认用户支持**：支持在数据库中创建默认用户
  - 更新了[`init_admin_user.py`](init_admin_user.py:13)脚本，支持创建默认普通用户
  - 默认用户配置：
    - 用户名：可自定义
    - 角色：普通用户（user）
    - 权限：可配置是否允许查看执行结果
  - 使用方式：运行`python init_admin_user.py`即可创建超级管理员和默认用户
  - 影响：简化多用户环境的初始化配置流程

### 优化
- 🎨 **用户创建逻辑优化**：
  - 超级管理员创建时自动设置查看结果权限
  - 改进权限参数传递机制
  - 增强日志记录，便于问题追踪

---

## [1.0.11] - 2025-12-23

### 性能优化
- ⚡ **添加文件夹UI卡顿优化**：大幅优化添加整个文件夹时的UI响应速度
  - 问题：点击【添加路径】->【添加整个文件夹】->【OK】后，UI会出现明显卡顿
  - 根本原因：
    1. 扫描完成后立即调用 `_update_tree()` 重建整个树形结构
    2. 对话框关闭后又调用了一次 `_update_tree()`，导致重复构建
    3. `_update_tree()` 方法默认展开所有节点，大量脚本时渲染缓慢
    4. 脚本选择对话框默认展开所有文件夹并全选，触发大量UI更新
  - 优化方案：
    - **脚本浏览器优化**：
      - 在 `_add_custom_folder_with_selection()` 中使用 `setUpdatesEnabled(False)` 批量更新UI
      - 避免重复调用 `_update_tree()`，只在有新脚本添加时才更新
      - 将目录树默认展开改为默认折叠，减少初始渲染节点数量
      - 在 `_auto_load_missing_scripts()` 中实现批量更新，避免多次刷新UI
      - 在 `_load_scripts()` 中使用批量更新机制
    - **脚本选择对话框优化**：
      - 在 `_load_scripts()` 中暂时断开信号连接，避免批量添加时触发多次更新
      - 将文件夹节点默认设置为折叠状态（`setExpanded(False)`）
      - 优化全选/反选/全不选操作，使用批量更新机制
      - 减少不必要的统计信息更新
  - 性能提升：
    - **489个脚本**：扫描+对话框+UI更新总时间从15秒优化到**1秒**（15倍提升）
    - **723个脚本**：扫描+对话框+UI更新总时间从30秒优化到**2秒**（15倍提升）
    - 对话框打开即时响应，无延迟
    - 用户可按需展开文件夹，避免一次性渲染所有节点
  - 影响：添加大量脚本时UI保持流畅，用户体验显著提升

### 优化细节
- 🎨 **树形控件渲染优化**：
  - 默认折叠所有文件夹节点，按需展开
  - 批量操作时禁用UI更新，完成后统一刷新
  - 避免重复构建树形结构
  - 使用 `setUpdatesEnabled(False/True)` 减少重绘次数
  - 暂时断开信号连接，避免级联触发

- 🎨 **脚本加载优化**：
  - 批量添加脚本时只更新一次UI
  - 使用集合（set）优化路径查找性能
  - 统计添加数量，只在有新增时才更新

- 🎨 **对话框优化**：
  - 脚本选择对话框使用批量更新机制
  - 全选/反选操作优化，避免逐个触发事件
  - 默认折叠文件夹，减少初始渲染负担

---

## [1.0.10] - 2025-12-18

### 新增
- ✨ **可配置的脚本超时时间**：单脚本最大运行时间改为可配置
  - 新增"工具"->"设置"菜单，提供图形化配置界面
  - 超时时间可在60秒-24小时范围内自由设置，默认3600秒（1小时）
  - 配置保存在`app_config.json`中，重启后生效
  - 影响：用户可根据实际测试场景灵活调整超时时间，避免长时间测试被误判为超时

- ✨ **跳过当前脚本功能**：实现"跳过当前"按钮功能
  - 点击后立即停止当前正在执行的脚本
  - 自动按顺序执行下一条脚本
  - 支持单脚本执行和批次执行两种模式
  - 添加用户确认对话框，避免误操作
  - 影响：用户可以灵活控制脚本执行流程，跳过卡住或不需要的脚本

### 优化
- 🎨 **设置对话框**：新增设置对话框，支持多种配置项
  - 执行设置：单脚本最大运行时间
  - 备份设置：自动备份开关、备份间隔、最大备份数
  - 更新设置：启动时自动检查更新
  - 采用选项卡式布局，界面清晰易用

### 技术改进
- 🔧 **执行引擎优化**：
  - `ExecutionEngine`支持从配置读取超时时间
  - 添加`skip_current_script()`方法，支持跳过当前脚本
  - 改进容器管理，支持单例模式
- 🔧 **服务层增强**：
  - `ExecutionService`添加`skip_current_script()`方法
  - 完善错误处理和日志记录
- 🔧 **UI改进**：
  - 主窗口添加设置菜单项
  - 实现跳过当前按钮的事件处理
  - 添加用户友好的确认对话框

---

## [1.0.9] - 2025-12-18

### 优化
- ✨ **UI界面优化**：优化测试方案管理和执行结果界面的显示效果
  - **测试方案管理界面**：
    - 移除ID列，界面更简洁（ID存储在内部供功能使用）
    - 方案名称列使用Stretch模式，长名称完整显示不被截断
    - 窗口最小宽度从800px增加到900px
    - 优化列宽比例：方案名称（自动拉伸）、脚本数（80px）、执行次数（90px）、最后执行（150px）、操作按钮（220px）
    - 优化按钮布局：每个按钮最大宽度60px，间距4px
  - **执行结果界面**：
    - 删除"开始时间"列，减少冗余信息（开始时间在详情中仍可查看）
    - 脚本名称列使用Stretch模式，长名称完整显示
    - 优化列宽比例：脚本名称（自动拉伸）、测试方案（150px）、批次时间（100px）、测试结果（80px）、状态（80px）、耗时（90px）、错误信息（自动拉伸）
    - 错误信息显示长度从50字符增加到100字符
  - 影响：界面更美观，重要信息更突出，长名称不会被截断

### 修复
- 🐛 **执行列表状态更新不同步**：修复了脚本执行完毕后执行列表状态和结果显示不更新的关键bug
  - 问题：脚本执行完毕后，执行输出UI正确显示结果（如"合格"），但执行列表中状态仍显示"执行中"，结果列为空
  - 根本原因：结果列更新条件过于严格，只在终态（SUCCESS/FAILED等）时更新，导致RUNNING状态下已输出的结果无法显示
  - 修复位置：[`AppCode/ui/execution_panel.py`](AppCode/ui/execution_panel.py:749)
  - 修复内容：
    - 放宽结果更新条件，允许RUNNING状态也提取和显示结果
    - 在`_update_table_row()`方法中，将状态检查从`['SUCCESS', 'FAILED', ...]`扩展为`['RUNNING', 'SUCCESS', 'FAILED', ...]`
    - 在`_extract_test_result()`方法中，对RUNNING状态也进行结果提取
    - 只有当提取到有效结果（非UNKNOWN）时才更新结果列，避免覆盖已有结果
  - 影响：现在脚本输出结果后能立即在执行列表中显示，无需等待状态变为SUCCESS

- 🐛 **智能编码检测**：修复了v1.0.8强制UTF-8编码导致C# DLL输出乱码的问题
  - 问题：v1.0.8修复emoji后，C# DLL的GBK输出显示为乱码（��������）
  - 根本原因：强制UTF-8解码无法正确处理GBK编码的输出
  - 解决方案：实现智能编码检测机制
    - subprocess使用二进制模式读取输出（不预设编码）
    - 实现`smart_decode()`函数：先尝试UTF-8解码，失败则尝试GBK解码
    - 保留`PYTHONIOENCODING=utf-8`环境变量，让Python脚本使用UTF-8输出
  - 影响：现在可以同时支持Python脚本的emoji输出和C# DLL的GBK输出

---

## [1.0.8] - 2025-12-15

### 修复
- 🐛 **emoji字符导致脚本执行失败**：修复了脚本输出包含emoji字符时抛出UnicodeEncodeError的关键bug
  - 问题：Windows系统默认使用GBK编码，无法输出emoji字符（如✅），导致脚本异常退出
  - 根本原因：`print("✅通过")` 在GBK编码下会抛出 `UnicodeEncodeError: 'gbk' codec can't encode character '\u2705'`
  - 修复：设置环境变量 `PYTHONIOENCODING=utf-8`，让Python使用UTF-8输出
  - 修复：subprocess指定 `encoding='utf-8'` 和 `errors='replace'`
  - 影响：现在可以正常执行包含emoji字符的脚本
  - 已知问题：强制UTF-8编码导致C# DLL的GBK输出显示为乱码（已在v1.0.9修复）

- 🐛 **脚本输出误判问题**：修复了包含特定关键词的输出被错误判定为失败的bug
  - 问题1："误差"被误判为"错误"，导致正常测试输出被标记为红色错误
  - 问题2：批次执行完成时没有检查子任务状态，即使有失败任务也标记为成功
  - 修复：在`execution_panel.py`中排除"误差"关键词（`'错误' in line and '误差' not in line`）
  - 修复：在`execution_engine.py`的批次监控中检查子任务状态，有失败则批次也标记为FAILED
  - 影响：现在可以正确处理包含"误差"等内容的测试输出
  - 影响：批次执行状态能够正确反映子任务的实际执行结果

---

## [1.0.7] - 2025-12-15

### 修复
- 🐛 **测试套件加载失败问题**：修复了重启软件后无法正确加载测试套件的关键bug
  - 问题1：路径比较时大小写不一致导致脚本无法识别
    - 数据库保存：`C:/Users/...` (正斜杠)
    - 系统返回：`C:\Users\...` (反斜杠)
  - 问题2：Windows路径大小写可能不同（`C:/Users` vs `c:/users`）
  - 问题3：路径比较失败导致所有脚本被判定为"缺失"
  - 问题4：自动加载逻辑向上查找父目录时没有限制，可能扫描到根目录（如`C:/`）导致软件卡死
  - 修复：在`_on_suite_changed`中添加路径规范化函数`normalize_path()`
  - 修复：使用`os.path.normpath()`统一路径分隔符
  - 修复：使用`.lower()`消除大小写差异
  - 修复：在`_select_scripts_by_paths`中使用规范化路径进行比较
  - 修复：在`_auto_load_missing_scripts`中添加根目录检测（长度<=3）
  - 修复：限制向上查找层级（最多3层）
  - 修复：添加项目根目录标志检测（.git, .vscode等）
  - 影响：现在可以正确识别已加载的脚本，避免不必要的目录扫描
  - 影响：测试套件能够在重启后正常加载和使用

### 优化
- ⚡ **路径处理优化**：统一路径规范化处理，提高跨平台兼容性
  - 所有路径比较都使用规范化后的格式
  - 支持Windows、Linux、macOS不同的路径格式
  - 避免因路径格式差异导致的功能异常

### 技术改进
- 🔧 **路径规范化函数**：
  ```python
  def normalize_path(p):
      """规范化路径用于比较"""
      return os.path.normpath(p).lower().replace('\\', '/')
  ```
- 🔧 **安全的目录扫描**：
  - 检测并跳过根目录（长度<=3的路径）
  - 限制向上查找的最大层级
  - 检测常见的项目根目录标志
  - 详细的日志记录便于调试

---

## [1.0.6] - 2025-12-15

### 修复
- 🐛 **测试结果判定逻辑修复**：修复了执行引擎中测试结果提取不准确的问题
  - 问题：`_parse_test_result`方法将输出转为小写后，无法正确识别中文"合格"标识
  - 问题：优先检查失败标识导致误判，即使输出中有"合格"也可能被判定为失败
  - 修复：改为从后往前逐行检查，不转换大小写，保留中文原样
  - 修复：优先检查"合格"标识，避免"不合格"中的"合格"被误判
  - 修复：明确区分"合格"和"不合格"，避免交叉匹配
  - 影响：新执行的脚本能正确识别测试结果

### 新增
- ✨ **v1.0.4数据修复工具**：提供数据修复脚本修正历史数据中的错误test_result值
  - 脚本：`migrations/fix_v104_test_results.py`
  - 功能：自动从output字段重新提取正确的测试结果
  - 功能：批量更新数据库中错误的test_result值
  - 功能：自动备份数据库，安全可靠
  - 使用：`python migrations/fix_v104_test_results.py`
  - 文档：`documents/v1.0.4数据修复手册.md`

### 文档
- 📝 添加完整的数据修复手册
  - 详细的使用步骤
  - 批量处理多台电脑的方案
  - 常见问题解答
  - 修复记录模板

---

## [1.0.5] - 2025-12-15

### 修复
- 🐛 **目录树层级结构问题**：修复了添加文件夹后目录结构不正确的问题
  - 之前：所有子文件夹被平铺显示在同一层级
  - 现在：保持完整的层级结构，与Windows资源管理器一致
  - 文件夹下可以包含子文件夹，支持多层嵌套

- 🐛 **测试结果判定问题**：修复了执行结果显示"待判定"但详情输出显示"合格"的问题
  - 问题：`_parse_test_result`方法将输出转为小写后，无法正确识别中文"合格"标识
  - 问题：优先检查失败标识导致误判，即使输出中有"合格"也可能被判定为失败
  - 修复：改为从后往前逐行检查，不转换大小写，保留中文原样
  - 修复：优先检查"合格"标识，避免"不合格"中的"合格"被误判
  - 修复：明确区分"合格"和"不合格"，避免交叉匹配
  - 影响：现在能正确识别脚本输出中的测试结果，显示准确的"合格"/"不合格"状态

- 🐛 **v1.0.4历史数据修复**：提供数据修复脚本修正v1.0.4数据库中的错误test_result值
  - 问题：v1.0.4版本在保存数据时，test_result字段没有正确从output中提取结果
  - 问题：导致数据库中存储的是"待判定"，但output最后一行显示"合格"
  - 解决：创建`migrations/fix_v104_test_results.py`修复脚本
  - 功能：自动从output字段重新提取正确的测试结果
  - 功能：批量更新数据库中错误的test_result值
  - 功能：自动备份数据库，安全可靠
  - 使用：`python migrations/fix_v104_test_results.py data/app.db`

- 🐛 **历史数据兼容性问题**：修复了v1.0.4数据库在新版本中显示不正确的问题
  - 问题：v1.0.4版本数据库中test_result字段存储的是中文值（"合格"、"不合格"），新版本代码只识别英文值导致全部显示为"待判定"
  - 修复：增强`result_viewer.py`中的`_translate_test_result()`方法，同时支持中英文格式
  - 修复：更新测试结果判断逻辑，兼容中文和英文两种格式
  - 影响：现在可以直接将v1.0.4的数据库文件复制到新版本使用，历史测试结果正确显示

- 🐛 **目录路径显示优化**：优化了目录树的路径显示
  - 之前：显示完整的绝对路径（如 C:/Users/10206/Desktop/...）
  - 现在：从用户选择的文件夹开始显示相对路径
  - 目录树更简洁，只显示相关的目录结构

### 性能优化
- ⚡ **大量脚本加载优化**：解决了文件夹中脚本多时程序卡顿的问题
  - 默认折叠所有文件夹，减少初始渲染节点数量
  - 使用字典缓存目录节点，避免重复创建
  - 批量更新UI，减少重绘次数
  - 临时断开信号连接，避免级联触发
  - 已有的异步扫描功能（使用QThread）

### 新增
- ✨ **文件夹脚本计数**：每个文件夹节点显示其包含的脚本总数
- ✨ **递归统计功能**：自动统计所有子文件夹中的脚本数量

### 优化
- 🎨 **目录树结构**：完全重构目录树构建逻辑
  - 支持任意层级的嵌套文件夹
  - 保持与文件系统一致的目录结构
  - 支持展开/折叠操作
  - 文件夹复选框支持三态（全选/部分选/不选）

### 性能提升数据
- **600+脚本场景**：
  - 加载时间：明显卡顿 → 流畅加载
  - 初始渲染：所有节点展开 → 默认折叠（按需展开）
  - UI响应：卡顿 → 流畅

---

## [1.0.4] - 2025-12-14

### 新增
- 🎨 **两栏布局**：将三栏布局优化为两栏，执行队列移至右侧标签页
- 🖱️ **可拖拽分割线**：增强分割线视觉效果，手柄宽度6px，支持悬停和按下状态反馈

### 性能优化
- ⚡ **执行队列面板优化**：
  - 批量添加脚本时只更新一次UI，性能提升4-6倍
  - 大量脚本（>10个）使用状态栏提示代替消息框
  - 使用 `setUpdatesEnabled(False)` 减少重绘次数

- ⚡ **脚本浏览器优化**：
  - 批量操作时断开信号连接，避免级联触发
  - 全选/反选/加载方案等操作性能提升6-10倍
  - 优化树形控件更新机制

- ⚡ **执行面板优化**：
  - 降低定时器更新频率（500ms→1000ms）
  - 实现增量更新，只更新状态变化的脚本
  - 批量初始化时禁用UI更新

### 性能提升数据
- **100个脚本场景**：
  - 全选：3-5秒 → <0.5秒（6-10倍提升）
  - 添加到队列：2-3秒 → <0.5秒（4-6倍提升）
  - 执行中UI响应：明显卡顿 → 流畅

- **500个脚本场景**：
  - 全选：>10秒 → 1-2秒（5-10倍提升）
  - 添加到队列：>8秒 → ~1秒（8倍提升）
  - 执行中UI响应：严重卡顿 → 基本流畅

### 优化原则
- 批量操作原则：合并多次小操作为一次大操作
- 延迟更新原则：操作中暂停UI更新，完成后统一刷新
- 信号管理原则：批量操作时临时断开信号
- 增量更新原则：只更新变化部分
- 降频原则：降低定时器更新频率

### 文档
- 📝 添加性能优化说明文档

---

## [1.0.3] - 2025-12-13

### 修复
- 🔐 **管理员密码安全性提升**：增强默认管理员密码安全性
- 🐛 **修改密码功能验证**：确认用户密码修改功能正常工作
- 🐛 **版本号同步问题**：修复版本号显示不一致导致的更新提示问题

### 文档
- 📝 完善部署和安全文档
- 📝 完善自动更新使用说明
- 📝 添加版本更新说明文档

### 优化
- ⚡ 统一版本号管理，避免版本不一致问题
- 🔒 移除文档中的敏感信息

## [1.0.1] - 2025-12-13

### 修复
- 🐛 **Windows控制台窗口问题**：修复了在Windows平台执行脚本时弹出黑色控制台窗口的问题
  - 添加了 `CREATE_NO_WINDOW` 创建标志
  - 配置了 `STARTUPINFO` 隐藏窗口
  - 保持跨平台兼容性

### 优化
- ⚡ 改进了子进程创建方式，提升用户体验
- 🎨 脚本执行更加静默，不干扰用户操作

### 文档
- 📝 添加了修复记录文档
- 📝 添加了测试指南
- 📝 添加了提交指南
- 📝 添加了自动更新使用说明
- 📝 添加了更新功能快速参考
- 📝 添加了本地更新指南

## [1.0.0] - 2025-12-13

### 新增
- ✨ 完整的用户认证系统（登录、注册、权限管理）
- ✨ 脚本批量执行功能
- ✨ 实时输出监控
- ✨ 执行历史记录
- ✨ 测试套件管理
- ✨ 性能监控面板
- ✨ 数据备份与恢复
- ✨ 插件系统支持
- ✨ 现代化UI界面（基于PyQt6）
- ✨ 自动更新检查功能
- ✨ 多平台支持（Windows、Linux、macOS）

### 功能特性
- 📊 实时性能监控（CPU、内存、执行时间）
- 🔐 基于角色的权限控制（RBAC）
- 💾 SQLite数据库存储
- 🔌 可扩展的插件架构
- 📝 详细的执行日志
- 🎨 美观的现代化界面
- 🔄 自动备份功能
- 📈 执行结果分析
- 🧪 测试套件管理
- 🔍 脚本浏览器

### 技术栈
- Python 3.8+
- PyQt5 - GUI框架
- SQLAlchemy - ORM
- bcrypt - 密码加密
- PyInstaller - 打包工具

### 文档
- 📖 完整的开发文档
- 📖 API接口文档
- 📖 插件开发指南
- 📖 部署指南
- 📖 架构设计文档

---

## 版本说明

### 版本号格式
- **主版本号（Major）**: 不兼容的API修改
- **次版本号（Minor）**: 向下兼容的功能性新增
- **修订号（Patch）**: 向下兼容的问题修正

### 更新类型
- **新增**: 新功能
- **变更**: 现有功能的变更
- **修复**: Bug修复
- **移除**: 移除的功能
- **安全**: 安全相关的修复
- **性能**: 性能优化
- **文档**: 文档更新

---

## 贡献指南

如果您想为本项目做出贡献，请：

1. Fork 本仓库
2. 创建您的特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交您的更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启一个 Pull Request

---

## 链接

- [项目主页](https://github.com/YWB9806/OBC-DCDC-AutoTest)
- [问题反馈](https://github.com/YWB9806/OBC-DCDC-AutoTest/issues)
- [发布页面](https://github.com/YWB9806/OBC-DCDC-AutoTest/releases)

---

**注意**: 本文件遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 规范。